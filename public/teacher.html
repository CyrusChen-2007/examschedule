<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8"/>
    <meta content="查询个人考试时间和地点(监考版）" name="description"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>

    <title>Test Schedule (Proctor Edition)</title>
    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
        }

        body {
            font-family: sans-serif;
            font-size: 16px;
            background-color: #fff4cc;
            color: #2c2415;
        }

        .page {
            width: min(130ch, 100%);
            margin: 0 auto;
            padding: 16px;
        }

        @media (min-width: 900px) {
            .page {
                padding: 24px;
            }
        }

        h1 {
            text-align: center;
            font-size: 32px;
            margin: 64px 0 10px;
            padding: 0;
            font-weight: 700;
            color: #4a3b16;
        }

        small:first-of-type {
            margin: 0 0 10px 0;
        }

        small {
            display: block;
            margin: 0 0 24px 0;
            text-align: center;
        }

        form {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            form {
                flex-direction: column;
                gap: 20px;
            }
        }


        button,
        input {
            outline: none;
        }

        input[type="text"],
        textarea[type="text"] {
            padding: 10px;
            font-size: 14px;
            line-height: 14px;
            border: 2px solid #6b5a2a;
            box-shadow: 3px 2px 0 #6b5a2a;
            transition: all 0.2s ease-in-out;
            width: 35ch;
            background-color: #fffdf3;
        }

        button {
            padding: 10px;
            font-size: 16px;
            line-height: 16px;
            color: black;
            background-color: #fff8df;
            border: 2px solid #b8871b;
            box-shadow: 3px 2px 0 #b8871b;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        input[type="text"]:hover,
        textarea[type="text"]:hover,
        button:hover {
            outline: none;
            border: 2px solid #d89b00;
            box-shadow: 4px 3px 0 #d89b00;
        }

        input[type="text"]:active,
        textarea[type="text"]:active,
        button:active {
            border: 2px solid #d89b00;
            box-shadow: 6px 4px 0 #d89b00;
        }

        #schedule {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(min(90vw, 400px), 1fr));
            width: 100%;
            margin: 64px auto 48px;
        }

        .test-session {
            display: grid;
            align-items: center;
            background: #fff;
            padding: 16px;
            border: 2px solid #000;
            box-shadow: 3px 2px 0 #000;
            transition: all 0.2s ease-in-out;

            grid-template-areas:
                "meta meta"
                "students students"
                "location proctors";
        }

        .test-session:hover {
            box-shadow: 6px 4px 0 #000;
        }

        .test-session > div:first-child {
            text-align: left;
            grid-area: meta;
        }

        .test-session > div:nth-child(2) {
            text-align: left;
            grid-area: students;
        }

        .test-session > div:nth-last-child(2) {
            text-align: left;
            grid-area: location;
        }

        .test-session > div:last-child {
            text-align: right;
            grid-area: proctors;
        }

        @media (max-width: 700px) {
            .test-session {
                grid-template-areas:
                    "meta"
                    "students"
                    "location"
                    "proctors";
            }

            .test-session > div:last-child {
                text-align: left;
                grid-area: proctors;
            }
        }

        span {
            font-weight: bold;
            color: #b06b00;
        }

        .hidden {
            opacity: 0;
            display: none;
            transform: scale(0.2) skew(180deg);
        }

        .fk {
            margin: 0;
            background-color: #fff;
            border: 2px solid #000;
            box-shadow: 3px 2px 0 #000;
            transition: all 0.2s ease-in-out;

            padding: 12px;
            max-width: 70ch;
        }

        .fk:hover {
            box-shadow: 4px 3px 0 #000;
        }

        #tog,
        #toglabel {
            cursor: pointer;
        }

        #tog,
        #content {
            display: none;
        }

        #toglabel::before {
            content: "▶";
        }

        #tog:checked + #toglabel::before {
            content: "▼";
        }

        #tog:checked + #toglabel + #content {
            display: block;
        }

        .info {
            background-color: #fff;
            border: 2px solid #000;
            box-shadow: 3px 2px 0 #000;
            transition: all 0.2s ease-in-out;
            padding: 12px;
        }

        .info:hover {
            box-shadow: 4px 3px 0 #000;
        }

        .info > a {
            text-decoration: none;
        }

        .info > a:hover {
            text-decoration: underline;
        }

        .gh {
            margin: 0;
            padding: 10px;
            border: 2px solid #000;
            box-shadow: 3px 2px 0 #000;
            background: #fff;
        }

        .gh > a {
            text-decoration: none;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .gh > a > span {
            color: #000;
            font-size: 12px;
            line-height: 1;
        }

        .gh > a > svg {
            width: 14px;
            height: 14px;
        }

        p.err {
            display: block;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid #000;
            box-shadow: 3px 2px 0 #000;
            padding: 10px;
            font-size: 24px;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
        }

        p.err:hover {
            box-shadow: 4px 3px 0 #000;
        }


        .page-footer {
            margin: 64px 0 24px;
            display: grid;
            gap: 12px;
        }

        .page-footer .footer-card {
            background: #fff;
        }

        input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding: 0;
            margin: 0;
            border: none;
            vertical-align: middle;
        }

        input[type="checkbox"]:checked::before {
            background-color: #000;
        }

        .show-group {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .checkbox-container {
            display: block;
            position: relative;
            --checkbox-color: #000;
        }

        .checkbox-container input[type="checkbox"] {
            display: block;
            background-color: transparent;
            padding: 12px;
            border: 2px solid var(--checkbox-color);
            box-shadow: 3px 2px 0 #000;
            transition: all 0.1s ease-out;
            cursor: pointer;
            transform: scale(1);
        }

        .checkbox-container input[type="checkbox"]:hover {
            --checkbox-color: #007779;
            box-shadow: 4px 3px 0 var(--checkbox-color);
        }

        .checkbox-container input[type="checkbox"]:active {
            --checkbox-color: #00a4aa;
            box-shadow: 6px 4px 0 var(--checkbox-color);
            transform: scale(1.1);
        }

        .checkbox-container #checkbox-show-indicator {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
            opacity: 0;
            width: 16px;
            height: 16px;
            margin: 6px;
            background-color: #000;
            z-index: 20;
            pointer-events: none;
            transform: scale(1.1);
            transition: all 0.1s ease-out;
        }

        .checkbox-container #checkbox-show-indicator.checked {
            opacity: 1;
            transform: scale(1);
        }

        .checkbox-container input[type="checkbox"]:hover + #checkbox-show-indicator {
            background-color: #007779;
        }

        .checkbox-container input[type="checkbox"]:active + #checkbox-show-indicator {
            background-color: #00a4aa;
            transform: scale(1.1);
        }

        .checkbox-container:hover + label {
            color: #007779;
        }
    </style>
    <link href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
</head>

<body>
<div class="page">
    <h1>BRS考试时刻表查询系统（监考版）</h1>
    <small>已经更新2025-2026学年第1学期期末考试，请老师们查收</small>
    <small style="color: red;">本网站的永久链接是：https://brsexam.approacher.org/，若您目前在使用临时链接，请保存收藏以免丢失</small>
    <div style="width: 100%; display: flex; justify-content: center; margin: 10px 0 24px; gap: 10px; align-items: center; flex-wrap: wrap;">
        <button id="lang-toggle"
                type="button"
                title="切换语言 / Switch language"
                style="font-size: 22px; padding: 18px 26px; line-height: 22px;">
            中文 / EN
        </button>
    </div>
    <small style="color: red;">【注意！本次部分学科的考试将不会出现在本列表中】</small>
    <small style="color: red;">【请核对自己的课表，若发现未显示的科目，请联系学科老师确认时间和地点】</small>
    <small id="names-hint">如果查不到，请使用以下列表内的名字查询：<a href="/proctorNamesList.txt">proctorNamesList.txt</a></small>
    <p id="student-link" style="color: #007779; text-align: center; margin: 0">
        学生考试查询：请访问<a href="/index.html">学生版</a>
    </p>

    <form>
        <input id="proctor-name" placeholder="请输入教师全名" type="text"/>
        <button type="submit">查找考试信息</button>
    <button id="download-ics" type="button" disabled title="请先查询考试信息">下载 Apple 日历 (.ics)</button>
        <div class="show-group">
            <div class="checkbox-container">
                <input id="checkbox-show" type="checkbox"/>
                <div id="checkbox-show-indicator"></div>
            </div>
            <label for="checkbox-show">显示考试学生</label>
        </div>
    </form>
    <div id="schedule"></div>

    <div class="page-footer" id="page-footer">
        <div class="gh footer-card" id="github">
            <a aria-label="Star plushugh/examschedule on GitHub" class="github-button"
               href="https://github.com/plushugh/examschedule">
                <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <title>GitHub</title>
                    <path
                            d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
                </svg>
                <span>Star this project on GitHub</span>
            </a>
        </div>

        <div class="info footer-card" id="contrib">
            这是一个
            <a href="https://fsf.org">自由软件</a>
            项目，由
            <a href="https://github.com/plushugh/examschedule">@plushugh</a>
            开发
            目前使用版本由
            <a href="https://github.com/CyrusChen-2007/examschedule/">@CyrusChen-2007</a>
            运营维护。
            <br>
            This is a
            <a href="https://fsf.org">Free Software</a>
            Project, developed by
            <a href="https://github.com/plushugh/examschedule">@plushugh</a>
            on GitHub,
            currently maintained by
            <a href="https://github.com/CyrusChen-2007/examschedule/">@CyrusChen-2007</a>.
        </div>

        <div class="fk footer-card" id="disclaimer">
            <input id="tog" type="checkbox"/>
            <label for="tog" id="toglabel">反馈/免责声明</label>
            <div id="content">
                <p id="disclaimer-text">
                    免责声明：本服务提供的考试信息仅供参考，不一定反映真实考试信息，具体请参照官方公布的考试信息。
                </p>

                <p id="contact-notice">
                    本版本增加了导入苹果日历的功能和中英文的切换，如果有任何的bug或是建议，请联系开发者。
                </p>

                <p id="contact-info">
                    电子邮箱 Email: <a href="mailto:cyjcyjcccyj@gmail.com">cyjcyjcccyj@gmail.com</a><br>
                    钉钉 Dingtalk: <span style="font-weight: 700; color: inherit;">cyruschen07</span>
                </p>
            </div>
        </div>
    </div>
</div>
<script>
    // ---- i18n (language switch) ----
    const LANG_KEY = "examschedule.lang";
    let lang = localStorage.getItem(LANG_KEY) || "zh"; // zh | en

    const i18n = {
        zh: {
            title: "BRS考试时刻表查询系统（监考版）",
            updated: "已经更新2025-2026学年第1学期期末考试，请老师们查收",
            permLink: "本网站的永久链接是：https://brsexam.approacher.org/，若您目前在使用临时链接，请保存收藏以免丢失",
            notice1: "【注意！本次部分学科的考试将不会出现在本列表中】",
            notice2: "【请核对自己的课表，若发现未显示的科目，请联系学科老师确认时间和地点】",
            namesHintPrefix: "如果查不到，请使用以下列表内的名字查询：",
            studentLink: "学生考试查询：请访问",
            studentLinkLabel: "学生版",
            proctorPlaceholder: "请输入教师全名",
            submit: "查找考试信息",
            showStudents: "显示考试学生",
            dlIcs: "下载 Apple 日历 (.ics)",
            dlNeedSearch: "请先查询考试信息",
            dlReady: "下载并导入到 Apple 日历",
            errNoData: "没有查找到考试信息",
            errFetch: "无法获取考试信息",
            len: "时长：",
            minutes: "分钟",
            students: "考试学生：",
            total: "共计",
            people: "人",
            location: "考试地点：",
            proctoredBy1: "由",
            proctoredBy2: "和",
            proctoredBy3: "监考",

            // footer / disclaimer
            contribHtml: `这是一个 <a href="https://fsf.org">自由软件</a> 项目，由 <a href="https://github.com/plushugh/examschedule">@plushugh</a> 开发，目前使用版本由 <a href="https://github.com/CyrusChen-2007/examschedule/">@CyrusChen-2007</a> 运营维护。`,
            disclaimerLabel: "反馈/免责声明",
            disclaimerText:
                "免责声明：本服务提供的考试信息仅供参考，不一定反映真实考试信息，具体请参照官方公布的考试信息。",
            contactNotice:
                "本版本增加了导入苹果日历的功能和中英文的切换，如果有任何的bug或是建议，请联系开发者。",
            contactEmailLabel: "电子邮箱 Email:",
            contactDingtalkLabel: "钉钉 Dingtalk:",
        },
        en: {
            title: "BRS Exam Schedule Lookup System (Proctor Edition)",
            updated: "Updated for 2025–2026 Semester 1 Final Exams",
            permLink:
                "Permanent link: https://brsexam.approacher.org/ (if you're using a temporary link, please bookmark it)",
            notice1: "[Notice] Some subjects may not be listed",
            notice2:
                "[Notice] Please double-check internal messages/timetable if any subjects are missing",
            namesHintPrefix: "If you can't find sessions, please search with names in:",
            studentLink: "Student please visit",
            studentLinkLabel: "Student Version",
            proctorPlaceholder: "Enter full teacher name",
            submit: "Find Proctoring Sessions",
            showStudents: "Show students",
            dlIcs: "Download Apple Calendar (.ics)",
            dlNeedSearch: "Please search first",
            dlReady: "Download and import into Apple Calendar",
            errNoData: "No proctoring session found",
            errFetch: "Unable to load proctoring sessions",
            len: "Duration: ",
            minutes: "minutes",
            students: "Students: ",
            total: "Total ",
            people: "",
            location: "Location: ",
            proctoredBy1: "Proctored by ",
            proctoredBy2: " and ",
            proctoredBy3: "",

            // footer / disclaimer
            contribHtml: `This is a <a href="https://fsf.org">Free Software</a> project, developed by <a href="https://github.com/plushugh/examschedule">@plushugh</a> on GitHub, currently maintained by <a href="https://github.com/CyrusChen-2007/examschedule/">@CyrusChen-2007</a>.`,
            disclaimerLabel: "Feedback / Disclaimer",
            disclaimerText:
                "Disclaimer: The exam information provided by this service is for reference only and does not necessarily reflect the actual exam information. Please refer to the official exam information for details.",
            contactNotice:
                "This version adds Apple Calendar import and a Chinese/English language switch. If you notice any bugs or have suggestions, please contact the developer.",
            contactEmailLabel: "Email:",
            contactDingtalkLabel: "Dingtalk:",
        },
    };

    function t(key) {
        return i18n[lang][key];
    }

    function applyLanguage() {
        document.documentElement.lang = lang === "en" ? "en" : "zh-CN";
        const h1 = document.querySelector("h1");
        if (h1) h1.textContent = t("title");

        const smalls = document.querySelectorAll("small");
        if (smalls[0]) smalls[0].textContent = t("updated");
    if (smalls[1]) smalls[1].textContent = t("permLink");
    if (smalls[2]) smalls[2].textContent = t("notice1");
    if (smalls[3]) smalls[3].textContent = t("notice2");

        const namesHint = document.querySelector("#names-hint");
        if (namesHint) {
            const link = namesHint.querySelector("a");
            namesHint.innerHTML = "";
            namesHint.appendChild(document.createTextNode(t("namesHintPrefix") + " "));
            if (link) namesHint.appendChild(link);
        }

        const studentLink = document.querySelector("#student-link");
        if (studentLink) {
            const a = studentLink.querySelector("a");
            studentLink.innerHTML = "";
            studentLink.appendChild(document.createTextNode(t("studentLink") + " "));
            if (a) {
                a.textContent = t("studentLinkLabel");
                studentLink.appendChild(a);
            }
        }

        const proctorInput = document.querySelector("#proctor-name");
        if (proctorInput) proctorInput.placeholder = t("proctorPlaceholder");

        const submitBtn = document.querySelector("form button[type='submit']");
        if (submitBtn) submitBtn.textContent = t("submit");

        const showLabel = document.querySelector("label[for='checkbox-show']");
        if (showLabel) showLabel.textContent = t("showStudents");

    const dlBtn = document.querySelector("#download-ics");
    if (dlBtn) dlBtn.textContent = t("dlIcs");

        // Footer: contribution + disclaimer block
        const contrib = document.querySelector("#contrib");
        if (contrib) {
            contrib.innerHTML = t("contribHtml");
        }

        const togLabel = document.querySelector("#toglabel");
        if (togLabel) {
            togLabel.textContent = t("disclaimerLabel");
        }

        const disclaimerText = document.querySelector("#disclaimer-text");
        if (disclaimerText) {
            disclaimerText.textContent = t("disclaimerText");
        }

        const contactNotice = document.querySelector("#contact-notice");
        if (contactNotice) {
            contactNotice.textContent = t("contactNotice");
        }

        const contactInfo = document.querySelector("#contact-info");
        if (contactInfo) {
            const mailLink = contactInfo.querySelector('a[href^="mailto:"]');
            const dingtalkSpan = contactInfo.querySelector("span");
            contactInfo.innerHTML = "";
            contactInfo.appendChild(document.createTextNode(t("contactEmailLabel") + " "));
            if (mailLink) {
                contactInfo.appendChild(mailLink);
            }
            contactInfo.appendChild(document.createElement("br"));
            contactInfo.appendChild(document.createTextNode(t("contactDingtalkLabel") + " "));
            if (dingtalkSpan) {
                contactInfo.appendChild(dingtalkSpan);
            }
        }
    }

    const langToggleBtn = document.querySelector("#lang-toggle");
    if (langToggleBtn) {
        langToggleBtn.addEventListener("click", () => {
            lang = lang === "zh" ? "en" : "zh";
            localStorage.setItem(LANG_KEY, lang);
            applyLanguage();
            if (lastProctorSessions && lastProctorName) {
                renderSchedule(lastProctorName, lastProctorSessions);
            }
        });
    }

    // ---- iCalendar (.ics) helpers (Apple Calendar compatible) ----
    function pad2(n) {
        const s = String(n);
        return s.length >= 2 ? s : `0${s}`;
    }

    function icsEscapeText(value) {
        return String(value)
            .replace(/\\/g, "\\\\")
            .replace(/\r\n|\n|\r/g, "\\n")
            .replace(/;/g, "\\;")
            .replace(/,/g, "\\,");
    }

    function foldIcsLine(line) {
        const limit = 75;
        if (line.length <= limit) return line;
        let out = "";
        for (let i = 0; i < line.length; i += limit) {
            const chunk = line.slice(i, i + limit);
            out += i === 0 ? chunk : `\r\n ${chunk}`;
        }
        return out;
    }

    function normalizeDate(examDate) {
        const parts = String(examDate).trim().split(/[./-]/).filter(Boolean);
        if (parts.length < 3) throw new Error(`Unrecognized examDate format: ${examDate}`);
        return {
            year: Number(parts[0]),
            month: Number(parts[1]),
            day: Number(parts[2]),
        };
    }

    function parseExamTime(examTime) {
        const cleaned = String(examTime).trim();
        const [rawStart, rawEnd] = cleaned.split("-").map((s) => s.trim());
        if (!rawStart || !rawEnd) throw new Error(`Unrecognized examTime format: ${examTime}`);

        const parseOne = (t) => {
            if (t.includes(":")) {
                const [hh, mm] = t.split(":");
                return { h: Number(hh), m: Number(mm) };
            }
            const digits = t.replace(/[^0-9]/g, "");
            const h = digits.length === 3 ? Number(digits.slice(0, 1)) : Number(digits.slice(0, 2));
            const m = Number(digits.slice(-2));
            return { h, m };
        };

        const s = parseOne(rawStart);
        const e = parseOne(rawEnd);
        return { startHour: s.h, startMin: s.m, endHour: e.h, endMin: e.m };
    }

    function formatLocalDateTime(y, mo, d, h, mi) {
        return `${y}${pad2(mo)}${pad2(d)}T${pad2(h)}${pad2(mi)}00`;
    }

    function safeUid(input) {
        return String(input)
            .trim()
            .replace(/\s+/g, "-")
            .replace(/[^A-Za-z0-9._-]/g, "-")
            .replace(/-+/g, "-")
            .replace(/^-|-$/g, "");
    }

    function generateIcsForSessions(ownerName, sessions, opts) {
        const timezone = (opts && opts.timezone) || "Asia/Shanghai";
        const calendarName = (opts && opts.calendarName) || `proctor: ${ownerName}`;
        const uidNamespace = (opts && opts.uidNamespace) || "exam.plushugh.com";
        const locale = (opts && opts.locale) || "zh"; // zh | en

        const now = new Date();
        const dtstamp = `${now.getUTCFullYear()}${pad2(now.getUTCMonth() + 1)}${pad2(now.getUTCDate())}T${pad2(
            now.getUTCHours(),
        )}${pad2(now.getUTCMinutes())}${pad2(now.getUTCSeconds())}Z`;

        const lines = [];
        lines.push("BEGIN:VCALENDAR");
        lines.push("VERSION:2.0");
        lines.push("PRODID:-//examschedule//ics export//EN");
        lines.push("CALSCALE:GREGORIAN");
        lines.push("METHOD:PUBLISH");
        lines.push(`X-WR-CALNAME:${icsEscapeText(calendarName)}`);
        lines.push(`X-WR-TIMEZONE:${icsEscapeText(timezone)}`);

        const sorted = [...sessions].sort((a, b) => {
            const ak = `${a.examDate} ${a.examTime} ${a.subject}`;
            const bk = `${b.examDate} ${b.examTime} ${b.subject}`;
            return ak.localeCompare(bk, "zh");
        });

        for (const s of sorted) {
            const { year, month, day } = normalizeDate(s.examDate);
            const { startHour, startMin, endHour, endMin } = parseExamTime(s.examTime);
            const dtStart = formatLocalDateTime(year, month, day, startHour, startMin);
            const dtEnd = formatLocalDateTime(year, month, day, endHour, endMin);

            const proctors = [s.proctor1, s.proctor2].filter(Boolean).join(" / ");

            // Language toggles: subject stays as-is, but labels change.
            const summary =
                locale === "en"
                    ? `Proctor: ${s.subject} (${s.grade}${s.classNum})`
                    : `监考: ${s.subject} (${s.grade}${s.classNum})`;

            const descriptionParts = [];
            if (locale === "en") {
                descriptionParts.push(`Proctor: ${ownerName}`);
                descriptionParts.push(`Time: ${s.examDate} ${s.examTime}`);
                descriptionParts.push(`Duration: ${s.minutes} minutes`);
                descriptionParts.push(`Proctored by: ${proctors}`);
                descriptionParts.push(`Students: ${s.numOfStudents}`);
                // Always include roster for proctor exports
                descriptionParts.push(`Roster: ${(s.students || []).join(", ")}`);
            } else {
                descriptionParts.push(`监考老师: ${ownerName}`);
                descriptionParts.push(`时间: ${s.examDate} ${s.examTime}`);
                descriptionParts.push(`时长: ${s.minutes} 分钟`);
                descriptionParts.push(`监考: ${proctors}`);
                descriptionParts.push(`学生人数: ${s.numOfStudents}`);
                // Always include roster for proctor exports
                descriptionParts.push(`学生名单: ${(s.students || []).join(", ")}`);
            }
            const description = descriptionParts.join("\n");

            const uid = `${safeUid(ownerName)}-${safeUid(s.examDate)}-${safeUid(s.examTime)}-${safeUid(
                s.subject,
            )}@${safeUid(uidNamespace)}`;

            lines.push("BEGIN:VEVENT");
            lines.push(`UID:${icsEscapeText(uid)}`);
            lines.push(`DTSTAMP:${dtstamp}`);
            lines.push(`DTSTART;TZID=${icsEscapeText(timezone)}:${dtStart}`);
            lines.push(`DTEND;TZID=${icsEscapeText(timezone)}:${dtEnd}`);
            lines.push(`SUMMARY:${icsEscapeText(summary)}`);
            lines.push(`LOCATION:${icsEscapeText(s.location)}`);
            lines.push(`DESCRIPTION:${icsEscapeText(description)}`);
            lines.push("END:VEVENT");
        }

        lines.push("END:VCALENDAR");
        return lines.map(foldIcsLine).join("\r\n") + "\r\n";
    }

    async function exportIcsToDevice(filename, content) {
        const mime = "text/calendar;charset=utf-8";
        const blob = new Blob([content], { type: mime });
        const file = new File([blob], filename, { type: mime });

        // Best effort for iOS: Share sheet lets users pick “Calendar” directly.
        try {
            if (
                navigator.share &&
                navigator.canShare &&
                navigator.canShare({ files: [file] })
            ) {
                await navigator.share({
                    files: [file],
                    title: filename,
                    text: filename,
                });
                return;
            }
        } catch (e) {
            // User canceled share or share failed; fall back to download/open.
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.rel = "noopener";

        document.body.appendChild(a);
        a.click();
        a.remove();

        setTimeout(() => {
            URL.revokeObjectURL(url);
        }, 10_000);
    }

    let showCheck = false;
    let lastProctorName = "";
    let lastProctorSessions = null;

    const downloadIcsBtn = document.querySelector("#download-ics");

    const showCheckbox = document.querySelector("#checkbox-show");
    const showCheckboxIndicator = document.querySelector(
        "#checkbox-show-indicator",
    );

    function setDownloadEnabled(enabled) {
        downloadIcsBtn.disabled = !enabled;
        downloadIcsBtn.title = enabled ? t("dlReady") : t("dlNeedSearch");
    }

        function renderSchedule(proctorName, testSessions) {
                const schedule = document.querySelector("#schedule");
                schedule.innerHTML = "";

                if (!testSessions) {
                        schedule.innerHTML = `<p class="err">${t("errNoData")}</p>`;
                        return;
                }

                for (const session of testSessions) {
                        const dateTime = `${session["examDate"]} ${session.examTime}`;
                        schedule.innerHTML += `
                            <div class="test-session">
                                <div>
                                    <div>
                                        ${dateTime}<br><span>${t("len")}</span> ${session.minutes} <span>${t("minutes")}</span>
                                    </div>
                                    <div>${session.subject} ${session.grade} ${session.classNum}</div>
                                </div>

                                ${
                                        showCheck
                                                ? `<div>
                                    <span>${t("students")}</span>${session.students && session.students.join(", ")}  <span>${t(
                                                            "total",
                                                    )}</span>${session.numOfStudents}<span>${t("people")}</span>
                                </div>`
                                                : ""
                                }

                                <div>
                                    <span>${t("location")}</span>${session.location}
                                </div>

                                <div>
                                    <span>${t("proctoredBy1")}</span>${session.proctor1}<span>${t("proctoredBy2")}</span>${
                                            session.proctor2
                                    }<span>${t("proctoredBy3")}</span>
                                </div>
                            </div>
                        `;
                }
        }

    showCheckbox.addEventListener("change", () => {
        if (showCheckbox.checked) {
            showCheck = true;
            showCheckboxIndicator.classList.toggle("checked", true);
        } else {
            showCheck = false;
            showCheckboxIndicator.classList.toggle("checked", false);
        }
    });

    fetch("/testSessionsByProctor.json")
        .then((res) => res.json())
        .then((testSessionsByProctor) => {
            const form = document.querySelector("form");

            const proctorNames = Object.keys(testSessionsByProctor);

            $(document).ready(function () {
                $("#proctor-name").autocomplete({
                    source: proctorNames
                });
            });

            form.addEventListener("submit", (event) => {
                event.preventDefault();

                const proctorName = document.querySelector("#proctor-name").value;

                const testSessions = testSessionsByProctor[proctorName];

                // update export state
                lastProctorName = proctorName;
                lastProctorSessions = testSessions || null;
                                setDownloadEnabled(Boolean(testSessions));
                                renderSchedule(proctorName, testSessions);
            });

            function doDownload(locale) {
                if (!lastProctorSessions || !lastProctorName) return;
                const ics = generateIcsForSessions(lastProctorName, lastProctorSessions, {
                    calendarName: locale === "en" ? `proctor: ${lastProctorName}` : `监考: ${lastProctorName}`,
                    timezone: "Asia/Shanghai",
                    uidNamespace: "exam.plushugh.com",
                    locale,
                });

                const safe = safeUid(lastProctorName) || "proctor";
                const suffix = locale === "en" ? "en" : "zh";
                exportIcsToDevice(`${safe}-proctor-${suffix}.ics`, ics);
            }

            // Single button: export language follows UI language.
            downloadIcsBtn.addEventListener("click", () => {
                doDownload(lang === "en" ? "en" : "zh");
            });

            applyLanguage();
            setDownloadEnabled(false);
        })
        .catch((err) => {
            document.querySelector("body").innerHTML =
                `<p class="err">${t("errFetch")}</p>`;
        });
</script>
<script async data-token="7fb81829-48b9-4fb6-9041-c11a9106b3a0"
        src="https://beamanalytics.b-cdn.net/beam.min.js"></script>
</body>

</html>
